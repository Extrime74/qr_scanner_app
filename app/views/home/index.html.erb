<div class="flex flex-col items-center mb-6 space-y-4">
  <h1 class="text-2xl font-bold text-gray-800">Сканирование QR-кода</h1>

  <%= link_to "Список записей", scan_records_path,
        class: "inline-block bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-xl shadow transition duration-300" %>
</div>

<div id="reader" class="w-full max-w-md mx-auto rounded-2xl border border-gray-200 shadow-lg p-6 bg-white transition duration-500 ease-in-out"></div>

<div id="notification" class="mt-4 text-center font-semibold text-sm transition-opacity duration-500"></div>

<script>
  window.qrScanner = {
    instance: null,
    isInitialized: false,
    isDestroying: false,

    init: function() {
      if (!document.getElementById('reader') || !window.Html5QrcodeScanner) {
        return false;
      }

      if (this.isInitialized || this.isDestroying) {
        return true;
      }

      try {
        this.instance = new Html5QrcodeScanner(
          'reader',
          {
            fps: 1,
            rememberLastUsedCamera: true,
            supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
          },
          false
        );

        this.instance.render((decodedText) => {
          this.onScanSuccess(decodedText);
        });

        this.isInitialized = true;
        return true;
      } catch (e) {
        console.error('Scanner init error:', e);
        return false;
      }
    },

    onScanSuccess: function(decodedText) {
      fetch("/scan_records", {
        method: "POST",
        headers: {
          "Accept": "application/json",
          "Content-Type": "application/json",
          "X-CSRF-Token": document.querySelector("meta[name='csrf-token']").content
        },
        body: JSON.stringify({ qr_data: decodedText })
      })
      .then(response => response.json().then(data => ({ status: response.status, body: data })))
      .then(({ status, body }) => {
        if (status === 201) {
          this.showNotification(body.message);
        } else if (status === 409) {
          this.showNotification(body.message, true);
        } else {
          this.showNotification("Ошибка: " + (body.message || body.errors), true);
        }
      })
      .catch(() => {
        this.showNotification("Ошибка сети", true);
      });
    },

    showNotification: function(message, isError) {
      const notif = document.getElementById('notification');
      if (notif) {
        notif.textContent = message;
        notif.className = `mt-4 text-center font-semibold text-sm opacity-100 transition-opacity duration-500 ${
          isError ? 'text-red-600' : 'text-green-600'
        }`;
        setTimeout(() => {
          notif.classList.add('opacity-0');
        }, 4000);
      }
    },

    destroy: function() {
      if (!this.instance || !this.isInitialized || this.isDestroying) {
        return Promise.resolve();
      }

      this.isDestroying = true;

      return new Promise((resolve) => {
        setTimeout(async () => {
          try {
            await this.instance.clear();
          } catch (e) {
            console.log('Scanner cleanup completed with warnings:', e);
          } finally {
            this.instance = null;
            this.isInitialized = false;
            this.isDestroying = false;
            resolve();
          }
        }, 300);
      });
    }
  };

  function initializeScanner() {
    if (!document.getElementById('reader')) return;

    if (!qrScanner.init()) {
      const checkInterval = setInterval(() => {
        if (window.Html5QrcodeScanner) {
          clearInterval(checkInterval);
          qrScanner.init();
        }
      }, 100);
    }
  }

  document.addEventListener('DOMContentLoaded', initializeScanner);
  document.addEventListener('turbo:load', initializeScanner);

  document.addEventListener('turbo:before-visit', async (event) => {
    if (event.detail.url === window.location.href) return;
    await qrScanner.destroy();
  });

  window.addEventListener('pageshow', (event) => {
    if (event.persisted && document.getElementById('reader') && qrScanner.isInitialized) {
      window.location.reload();
    }
  });

  document.addEventListener('turbo:render', () => {
    if (document.getElementById('reader') && qrScanner.instance && !qrScanner.isInitialized) {
      initializeScanner();
    }
  });
</script>
