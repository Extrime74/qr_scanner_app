 <div class="max-w-4xl mx-auto px-6 py-10">
  <div class="flex flex-col items-center mb-10 space-y-4">
    <h1 class="text-3xl font-bold text-gray-800">–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥</h1>

    <div id="reader" class="w-full max-w-md mx-auto rounded-2xl border border-gray-200 shadow-lg p-6 bg-white transition duration-500 ease-in-out"></div>

    <%= link_to "–°–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π", scan_records_path,
      class: "inline-flex items-center gap-2 bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-2 px-5 rounded-lg shadow-sm hover:shadow-md transition duration-200" %>

    <div id="notification" class="mt-6 text-center font-semibold text-sm transition-opacity duration-500"></div>
  </div>
</div>

<!-- üéµ –ê—É–¥–∏–æ—ç–ª–µ–º–µ–Ω—Ç—ã -->
<audio id="success-audio" src="/sounds/success.mp3" preload="auto"></audio>
<audio id="error-audio" src="/sounds/error.mp3" preload="auto"></audio>

<script>
  window.qrScanner = {
    instance: null,
    isInitialized: false,
    isDestroying: false,

    init: function() {
      if (!document.getElementById('reader') || !window.Html5QrcodeScanner) {
        return false;
      }

      if (this.isInitialized || this.isDestroying) {
        return true;
      }

      try {
        this.instance = new Html5QrcodeScanner(
          'reader',
          {
            fps: 1,
            rememberLastUsedCamera: true,
            aspectRatio: 1,
            qrbox: (videoWidth, videoHeight) => {
              const width = videoWidth * 0.7;
              const height = videoHeight * 0.7;
              return { width, height };
            },
            supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
          },
          false
        );

        this.instance.render((decodedText) => {
          this.onScanSuccess(decodedText);
        });

        this.isInitialized = true;
        return true;
      } catch (e) {
        console.error('Scanner init error:', e);
        return false;
      }
    },

    onScanSuccess: function(decodedText) {
      fetch("/scan_records", {
        method: "POST",
        headers: {
          "Accept": "application/json",
          "Content-Type": "application/json",
          "X-CSRF-Token": document.querySelector("meta[name='csrf-token']").content
        },
        body: JSON.stringify({ qr_data: decodedText })
      })
      .then(response => response.json().then(data => ({ status: response.status, body: data })))
      .then(({ status, body }) => {
        let timestamp = '';
        if (body.created_at) {
          const date = new Date(body.created_at);
          const day = String(date.getDate()).padStart(2, '0');
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const year = date.getFullYear();
          timestamp = ` (–ø–æ–≤—Ç–æ—Ä –æ—Ç ${day}.${month}.${year})`;
        }

      let statusText = body.message + timestamp;
      let message = `ID QR –∫–æ–¥–∞: ${body.id || '‚Äì'}\n–¢–µ–∫—Å—Ç QR –∫–æ–¥–∞: ${body.qr_code_text || '‚Äì'}\n\n–°—Ç–∞—Ç—É—Å: ${statusText}`;


        if (status === 201) {
          this.playSound(true); // ‚úÖ –£—Å–ø–µ—Ö
          this.showNotification(message);
        } else if (status === 409) {
          this.playSound(false); // ‚ùå –ü–æ–≤—Ç–æ—Ä
          this.showNotification(message, true);
        } else {
          this.playSound(false); // ‚ùå –û—à–∏–±–∫–∞
          this.showNotification("–û—à–∏–±–∫–∞: " + (body.message || body.errors), true);
        }
      })
      .catch(() => {
        this.playSound(false); // ‚ùå –°–µ—Ç—å
        this.showNotification("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏", true);
      });
    },

    showNotification: function(message, isError) {
      const notif = document.getElementById('notification');
      if (notif) {
        notif.textContent = message;
        notif.className = `mt-6 text-center font-semibold text-sm opacity-100 transition-opacity duration-500 ${
          isError ? 'text-red-600' : 'text-green-600'
        }`;
        setTimeout(() => {
          notif.classList.add('opacity-0');
        }, 4000);
      }
    },

    playSound: function(isSuccess) {
      const audio = document.getElementById(isSuccess ? 'success-audio' : 'error-audio');
      if (audio) {
        audio.currentTime = 0;
        audio.play().catch((err) => {
          console.warn("Audio playback failed:", err);
        });
      }
    },

    destroy: function() {
      if (!this.instance || !this.isInitialized || this.isDestroying) {
        return Promise.resolve();
      }

      this.isDestroying = true;

      return new Promise((resolve) => {
        setTimeout(async () => {
          try {
            await this.instance.clear();
          } catch (e) {
            console.log('Scanner cleanup completed with warnings:', e);
          } finally {
            this.instance = null;
            this.isInitialized = false;
            this.isDestroying = false;
            resolve();
          }
        }, 300);
      });
    }
  };

  function initializeScanner() {
    if (!document.getElementById('reader')) return;

    if (!qrScanner.init()) {
      const checkInterval = setInterval(() => {
        if (window.Html5QrcodeScanner) {
          clearInterval(checkInterval);
          qrScanner.init();
        }
      }, 100);
    }
  }

  document.addEventListener('DOMContentLoaded', initializeScanner);
  document.addEventListener('turbo:load', initializeScanner);

  document.addEventListener('turbo:before-visit', async (event) => {
    if (event.detail.url === window.location.href) return;
    await qrScanner.destroy();
  });

  window.addEventListener('pageshow', (event) => {
    if (event.persisted && document.getElementById('reader') && qrScanner.isInitialized) {
      window.location.reload();
    }
  });

  document.addEventListener('turbo:render', () => {
    if (document.getElementById('reader') && qrScanner.instance && !qrScanner.isInitialized) {
      initializeScanner();
    }
  });
</script>